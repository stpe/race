data.sort((c,a)=>c.laps[0].l_time-a.laps[0].l_time).forEach(a=>{a.info.club=decodeAmps(a.info.club)});let lapsCount=30;window.chartColors={red:"rgb(255, 99, 132)",orange:"rgb(255, 159, 64)",yellow:"rgb(255, 205, 86)",green:"rgb(75, 192, 192)",blue:"rgb(54, 162, 235)",purple:"rgb(153, 102, 255)",grey:"rgb(201, 203, 207)"};let clubNormalization={"Uppsala RC":"Uppsala Racing Club","SMK DALA":"SMK Dala Falun"},sessions={Practice:"blue",Qualy:"yellow",Final:"red"};Chart.defaults.global.legend.display=!1;var options,color=Chart.helpers.color;function formatLapTime(a){return(+a/1e3).toFixed(3)}function decodeAmps(a){return["\xE5","\xE4","\xF6","\xC5","\xC4","\xD6"].forEach(b=>{a=a.replace("&#"+b.charCodeAt(0)+";",b)}),a}function getDriverFastestLapTime(a){return a.laps.reduce((a,b)=>b.l_time<a?b.l_time:a,Number.MAX_SAFE_INTEGER)}function getDriverAverageLapTime(a){let b=a.laps.slice(0,lapsCount).reduce((a,b)=>+b.l_time+a,0);return b/lapsCount}function addTableRow(a,b){let c=a?getDriverAverageLapTime(a):"",d=a?getDriverFastestLapTime(a):"",e=a?a.laps.length:"";return`
    <tr class="driver${a.selected?" selected":""}" id="${a?a.info.key:""}">
      <td class="info" title="${b}.">${a?a.info.prename:""} ${a?a.info.name:""}</td>
      <td class="viz">
        <canvas class="lapcanvas" id="${a?a.info.key:"bottom"}-canvas" height="18" width="300"></canvas>
      </td>
      <td class="avg">${a?formatLapTime(c):""}</td>
      <td class="fastest">${a?formatLapTime(d):""}</td>
      <td class="total">${e}</td>
    </tr>
  `}function setOptions(a,b){options={scales:{yAxes:[{ticks:{min:0,max:2.5,display:!1},gridLines:{display:!1,drawBorder:!1}}],xAxes:[{ticks:{min:+a,max:+b+20,display:!1,callback:function(a){return 0==a%1e3?formatLapTime(a):null}},gridLines:{display:!0,drawBorder:!1}}]},tooltips:{callbacks:{label:function(a,b){return formatLapTime(a.xLabel)+"s ("+b.datasets[a.datasetIndex].label+")"}}}}}function initFilter(a){let b=Object.keys(a.reduce((a,b)=>(a[clubNormalization[b.info.club]||b.info.club]=1,a),{})).sort();document.getElementById("clubs").innerHTML="<option value=\"\">Klubb...</option>"+b.map(a=>"<option value=\""+a+"\">"+a+"</option>").join("\n");let c=a.map(a=>({name:a.info.prename+" "+a.info.name,key:a.info.key}),{}).sort((c,a)=>c.name.localeCompare(a.name));document.getElementById("drivers").innerHTML="<option value=\"\">J\xE4mf\xF6r med...</option>"+c.map(a=>"<option value=\""+a.key+"\">"+a.name+"</option>").join("\n")}function initChart(a,b,c,e,d){lapsCount=d;let f=0,g=Number.MAX_SAFE_INTEGER,h=0,i=a.filter(a=>c&&a.info.key===c?(a.selected=!0,h++,!0):!(0<e&&h>=e)&&(console.log(h+" ("+e+")"),!b||a.info.club.includes(b))&&(h++,!0));i.forEach(a=>{let b=a.laps.slice(0,lapsCount);b[0].l_time<g&&(g=b[0].l_time),b[b.length-1].l_time>f&&(f=b[b.length-1].l_time)}),setOptions(g,f);let j=document.getElementById("tablebody");j.innerHTML="";let k=[];i.forEach((a,b)=>{k.push(addTableRow(a,b+1))}),j.innerHTML=k.join(""),renderChart(i)}function renderChartRow(a){let b=document.getElementById(a?a.info.key+"-canvas":"bottom-canvas"),c=a?a.laps.slice(0,lapsCount):[];a||(options.scales.xAxes[0].ticks.display=!0,b.setAttribute("height",23));let d={datasets:Object.keys(sessions).map((b,d)=>{let e=a?c.filter(a=>a.info.heat.startsWith(b)).map(a=>({x:a.l_time,y:d})):[];return{label:b,borderColor:window.chartColors[sessions[b]],backgroundColor:color(window.chartColors[sessions[b]]).alpha(.2).rgbString(),data:e}})},e=new Chart(b,{type:"scatter",data:d,options:options})}function renderChart(a){a.forEach(a=>renderChartRow(a))}function updateFilter(){let a=document.getElementById("clubs"),b=-1!==a.selectedIndex&&a.options[a.selectedIndex].value,c=document.getElementById("drivers"),d=-1!==c.selectedIndex&&c.options[c.selectedIndex].value,e=document.getElementById("count"),f=-1!==e.selectedIndex&&e.options[e.selectedIndex].value,g=document.getElementById("lapcount"),h=-1!==g.selectedIndex&&g.options[g.selectedIndex].value;initChart(data,b,d,parseInt(f),parseInt(h))}document.getElementById("clubs").addEventListener("change",updateFilter),document.getElementById("drivers").addEventListener("change",updateFilter),document.getElementById("count").addEventListener("change",updateFilter),document.getElementById("lapcount").addEventListener("change",updateFilter),initFilter(data),updateFilter();